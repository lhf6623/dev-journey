<template component>
  <input
    attr:placeholder="`搜索 ${sys_store.is_mac ? '⌘':'Ctrl'} K`"
    list="menus"
    :value="inputValue"
    on:change="toggle"
    type="search"
    class="relative w168px box-border px6px py0px rounded placeholder:text-12px b b-solid b-theme-border"
    id="test_123"
  />
  <datalist id="menus">
    <x-fill :value="sys_store.menus">
      <option :value="$host.changeText($data)" />
    </x-fill>
  </datalist>
  <script type="module">
    export const tag = "l-search";
    import { keyboard } from "../js/Keyboard.mjs";
    export default async function ({ load }) {
      const { sys_store, mdbook, leetcode, handleFileSuffix, setSysTitle } =
        await load("../store/system.js");
      return {
        data: {
          sys_store: {},
          inputValue: "",
        },
        attached() {
          this.sys_store = sys_store;
          keyboard.on("Ctrl-K", this.focusInput, this);
        },
        detached() {
          this.sys_store = null;
          keyboard.off("Ctrl-K", this.focusInput, this);
        },
        proto: {
          // 监听按键 聚焦输入框
          focusInput() {
            this.shadow.ele.querySelector("input").focus();
          },
          changeText: handleFileSuffix,
          async toggle(e) {
            const _title = e.target.value.trim();
            if (!_title) return;
            const suffix =
              this.sys_store.document_type == mdbook ? ".md" : ".js";

            const inMenu = this.sys_store.menus.reduce((pre, curr) => {
              if (pre === true) return pre;
              return curr === `${_title}${suffix}`;
            }, false);

            if (!inMenu) return;

            this.inputValue = e.target.value;
            this.inputValue = "";
            setSysTitle(`${_title}${suffix}`);
          },
        },
      };
    }
  </script>
</template>
