<template component>
  <l-m src="./common/l-button.html"></l-m>
  <l-m src="./common/l-select.html"></l-m>
  <div id="console-list" attr:class="`${theme} hfull relative overflow-auto`">
    <div class="b-b b-b-theme-hover text-sm flex items-center flex-wrap gap6px">
      <l-button
        on:on-click="clear"
        :icon="'i-lsicon:disable-outline'"
        title="清空运行结果"
      >
      </l-button>
      <l-select
        :multiple="true"
        :options="logLevel"
        :option-icon="'i-line-md:confirm'"
        :value="logLevelValue"
        on:select="changeLogLevel"
        :label="'所有级别'"
      >
      </l-select>
      <x-if :value="logList.length - filterLogList.length > 0">
        <p class="text-xs text-theme-text">
          {{logList.length - filterLogList.length}}个已隐藏
        </p>
      </x-if>
    </div>
    <ul
      class="px6px text-14px text-#1c1c1c dark:text-#fff bg-#fff !dark:bg-transparent"
    >
      <x-fill :value="filterLogList">
        <li attr:class="`${$host.getCls($data)} relative rounded px22px my3px`">
          <div
            attr:class="`${$host.getCls($data) ? '!b-none' : ''} overflow-hidden b-b-solid b-b-1px b-b-#cadbfd dark:b-b-#4c4c4c`"
          >
            <pre>{{$data.info}}</pre>
          </div>
        </li>
      </x-fill>
    </ul>
  </div>

  <script type="module">
    import dayjs from "https://esm.sh/dayjs@1.11.13";

    export const tag = "l-console-list";
    export default async function ({ load }) {
      const { watchHtmlTheme } = await load("../js/util.js");
      const cls = {
        warn: "bg-#fef4cb text-#2f2400 dark:bg-#322e1d dark:text-#efe591",
        error: "bg-#fae6e6 text-#492222 dark:bg-#3c2728 dark:text-#eececd",
      };
      return {
        data: {
          theme: "light",
          observer: null,
          /**
           * 日志列表
           * {
           *  type: typeof console,
           *  time: '12:00:00',
           *  info: '日志信息',
           * }
           */
          logList: [],
          filterLogList: [],
          logLevelValue: ["verbose", "info", "warn", "error"],
          logLevel: [
            {
              label: "详细",
              value: "verbose",
            },
            {
              label: "信息",
              value: "info",
            },
            {
              label: "警告",
              value: "warn",
            },
            {
              label: "错误",
              value: "error",
            },
          ],
        },

        watch: {
          logList(val) {
            this.handleLogList();
          },
          logLevelValue(val) {
            this.handleLogList();
          },
        },
        attached() {
          this.observer = watchHtmlTheme((theme) => {
            this.theme = theme;
          });
        },
        detached() {
          this.observer && this.observer();
          this.observer = null;
        },
        proto: {
          handleLogList() {
            // 不知道怎么过滤，先这样
            this.filterLogList = this.logList.filter((item) => {
              if (["info", "warn", "error"].includes(item.type)) {
                return this.logLevelValue.includes(item.type);
              }
              return this.logLevelValue.includes("verbose");
            });
          },
          changeLogLevel({ data }) {
            if (data === "default") return;

            if (this.logLevelValue.includes(data)) {
              this.logLevelValue = this.logLevelValue.filter(
                (item) => item !== data
              );
            } else {
              this.logLevelValue.push(data);
            }
          },
          getLevel(val) {
            return this.logLevelValue.includes(val);
          },
          // 清空
          clear() {
            this.emit("clear");
          },
          scrollBottom() {
            const ele = this.shadow.ele;
            // 滚动到底部
            setTimeout(() => {
              const consoleList = ele.querySelector("#console-list");
              consoleList.scroll({
                top: consoleList.scrollHeight + 30,
                behavior: "smooth",
              });
            }, 300);
          },
          getCls(data) {
            return cls[data.type];
          },
        },
      };
    }
  </script>
</template>
