<template component>
  <link
    rel="stylesheet"
    href="../css/uno.css"
  />
  <link
    rel="stylesheet"
    href="../css/theme-one-dark.css"
  />
  <div
    id="code"
    attr:class="`${theme.val} h-full relative *:h-full`"
  ></div>

  <script type="module">
    import { basicSetup, EditorView } from "https://esm.sh/codemirror@6.0.1";
    import { javascript } from "https://esm.sh/@codemirror/lang-javascript@6.0.1";
    import Cache from "../js/cache.js";

    export const tag = "l-editor";
    export default async function ({ load } = 1) {
      const { code, theme, editorCode, isReset, title, menus_index } =
        await load("../js/store.js");
      let editor = null;
      let timeoutId = null;

      return {
        data: {
          theme: {},
          code: {},
          editorCode: {},
          isReset: {},
        },
        watch: {
          // ç‚¹å‡»èœå•æ—¶
          code(_code) {
            if (!editor) return;
            if (!_code.val) return;

            editorCode.val = _code.val;
            setTimeout(() => {
              this.changeEditorCode(_code.val);
            }, 100);
          },
          // è¿˜åŽŸä»£ç 
          isReset(_isReset) {
            if (_isReset.val) {
              editorCode.val = code.val;
              this.changeEditorCode(editorCode.val);
              isReset.val = false;
            }
          },
        },
        loaded() {
          editor = new EditorView({
            doc: Cache.getItem(tag) ?? code.val,
            extensions: [
              basicSetup,
              javascript(),
              EditorView.updateListener.of((update) => {
                if (update.changes) {
                  clearTimeout(timeoutId);
                  timeoutId = setTimeout(() => {
                    editorCode.val = editor.state.doc.toString();
                    Promise.resolve().then(Cache.setItem(tag, editorCode.val));
                  }, 300);
                }
              }),
            ],
            parent: this.shadow.ele.querySelector("#code"),
          });

          // ç½‘é¡µä¸€æ‰“å¼€å°±èšç„¦åˆ°ç¼–è¾‘å™¨
          setTimeout(() => {
            editor.focus();
          }, 300);
        },
        attached() {
          this.theme = theme;
          this.code = code;
          this.editorCode = editorCode;
          this.isReset = isReset;
        },
        detached() {
          this.theme = null;
          this.code = null;
          this.editorCode = null;
          this.isReset = null;
        },
        proto: {
          changeEditorCode(code) {
            console.dir(`ðŸš€ ~ code:`, code);

            let transaction = editor.state.update({
              changes: {
                from: 0,
                to: editor.state.doc.length,
                insert: code ?? "",
              },
            });
            editor.dispatch(transaction);
          },
        },
      };
    }
  </script>
</template>
