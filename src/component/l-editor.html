<template component>
  <div class="hfull overflow-hidden">
    <iframe
      id="iframe"
      src="./CodeMirrorIframe/index.html"
      attr:class="`hfull relative ${loading ? 'w-0': 'w-full'}`"
    ></iframe>
  </div>

  <script type="module">
    export const tag = "l-editor";
    export default async function ({ load }) {
      const { setLeetcodeCode, page_store } = await load(
        "../store/page-store.js"
      );
      const { sys_store } = await load("../store/system.js");
      let timeoutId = null;
      return {
        data: {
          sys_store: {},
          page_store: {},
          code: "",
          updateCode: "",
          iframe: null,
          loading: true,
        },
        watch: {
          "sys_store.theme"(value) {
            this.selectTheme();
          },
          updateCode(time) {
            if (!time) return;
            if (!this.code) return;

            this.changeEditorCode(this.code ?? "");
          },
        },
        loaded() {
          this.iframe = this.shadow.ele.querySelector("#iframe");

          window.addEventListener("message", (event) => {
            if (event.data?.id === "codemirror") {
              const { fn, ags } = event.data;
              // 元素初次加载
              if (fn === "load") {
                this.emit("load");
                this.changeEditorCode(this.code ?? "");
                this.loading = false;
              } else {
                if (this[fn] && typeof this[fn] === "function") {
                  this[fn](...(ags || []));
                }
              }
            }
          });
        },
        attached() {
          this.sys_store = sys_store;
          this.page_store = page_store;
        },
        detached() {
          this.sys_store = null;
          this.page_store = null;
          this.iframe = null;
        },
        proto: {
          postMessage(fn, ags) {
            if (!this.iframe) return;
            this.iframe.contentWindow.postMessage(
              { id: "codemirror", fn, ags },
              "*"
            );
          },
          selectTheme() {
            if (!this.sys_store) return;
            this.postMessage("setTheme");
          },
          changeEditorCode(code) {
            if (this.iframe) {
              this.postMessage("setValue", [code]);

              this.emit("load");
            }
          },
          setCode(code) {
            setLeetcodeCode(code);
          },
        },
      };
    }
  </script>
</template>
