<template page>
  <link rel="stylesheet" href="../css/uno.css" />
  <link rel="stylesheet" href="../css/highlightjs.css?v=0.2.3" />
  <l-m src="../component/common/l-button.html"></l-m>
  <div attr:class="`md ${sys_store.theme} relative hfull overflow-auto`">
    <l-button
      title="下载文档为PDF"
      class="fixed right-18px mt3px bg-amber dark:bg-blue rounded-3px z100"
      :icon="'i-tabler:pdf'"
      on:on-click="getPdf"
      :loading="pdfLoading"
    >
    </l-button>
    <div
      id="pdf"
      class="bg-theme-bg-color relative max-w794px min-w-595px mx-auto"
    >
      <h1 class="text-center tracking-2px">{{getTitle(title)}}</h1>
      <div :html="mdTxt" id="md" class="px40px all:transition-200"></div>
    </div>
    <div h-40px></div>
  </div>

  <script>
    import { Marked } from "https://esm.sh/marked@14.1.3";
    import { markedHighlight } from "https://esm.sh/marked-highlight@2.2.0";
    import hljs from "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/es/highlight.min.js";
    import { jsPDF } from "https://esm.sh/jspdf@2.5.2";
    import html2canvas from "https://esm.sh/html2canvas@1.4.1";
    import {
      imgClipByPage,
      checkImgEmptyLine,
      colorDistance,
    } from "../js/util.js";

    export default async ({ load }) => {
      const {
        sys_store,
        changeType,
        handleFileSuffix,
        setSysTitle,
        getContent,
        mdbook,
      } = await load("../store/system.js");
      const { page_store, setMdContent, setMdTitle } = await load(
        "../store/page-store.js"
      );

      let marked = null;
      let tim = null;
      return {
        parent: "../layout-page.html",
        data: {
          mdTxt: "加载中。。。",
          sys_store: {},
          pdfLoading: false,
          title: "",
        },
        watch: {
          async "sys_store.title"(data) {
            if (!this.sys_store || this.sys_store.document_type !== mdbook) {
              return;
            }
            const { title } = this.sys_store || {};

            if (title && title !== this.page_store.md_title) {
              setMdTitle(title ?? "");
              const content = await getContent();
              setMdContent(content);
              this.renderMd(content);
              this.title = title;
            }
          },
        },
        detached() {
          this.sys_store = null;
          this.page_store = null;
          this.shadow.off("click", this.copyCode);
        },
        ready() {
          this.shadow.on("click", this.copyCode);
        },
        attached() {
          changeType("mdbook", page_store.md_title);
          this.sys_store = sys_store;
          this.page_store = page_store;
          marked = new Marked(
            markedHighlight({
              emptyLangClass: "hljs",
              langPrefix: "hljs language-",
              highlight(code, lang, info) {
                const language = hljs.getLanguage(lang) ? lang : "plaintext";
                const value = hljs.highlight(code, { language }).value;
                // 把特殊字符 比如 < 转义一下
                const _code = encodeURI(code);
                const _value = `<div class="cus-title"><span>${language}</span><button data-code="${_code}" class="copy-btn">复制</button></div>${value}`;
                return _value;
              },
            })
          );

          setTimeout(async () => {
            let content = "";
            if (this.page_store.md_content) {
              content = page_store.md_content;
              this.title = page_store.md_title;
            } else {
              content = await getContent();
              setMdContent(content);
              setMdTitle(this.sys_store.title);
              this.title = this.sys_store.title;
            }

            this.renderMd(content);
          }, 100);
        },
        proto: {
          getTitle: handleFileSuffix,
          copyCode(e) {
            const color = "text-#18a058";
            let el = e.target;

            const isButton = (_el) =>
              _el.tagName === "BUTTON" && _el.className.includes("copy-btn");

            if (!isButton(el)) return;

            const code = decodeURI(el.dataset.code);
            if (tim) {
              clearTimeout(tim);
              tim = null;
            }

            navigator.clipboard.writeText(code).then(() => {
              el.textContent = "已复制";
              el.classList.toggle(color);

              tim = setTimeout(() => {
                el.textContent = "复制";
                el.classList.toggle(color);
                tim = null;
              }, 2000);
            });
          },
          // 滚动到顶
          scrollToTop() {
            const ele = this.shadow.ele;
            const mdDom = ele.querySelector(".md");
            mdDom.scrollTo({ top: 0, behavior: "smooth" });
          },
          /** 渲染md */
          renderMd(mdTxt) {
            this.mdTxt = marked.parse(mdTxt);
          },
          /** 向上寻找最近的空行 */
          findNearestEmptyLine(canvas, ctx, findY, page) {
            const step = 4; // 向上搜索的步长
            let currentY = findY;
            while (currentY >= 0) {
              const isEmpty = checkImgEmptyLine(canvas, ctx, currentY, page);
              if (isEmpty) {
                return currentY;
              }
              currentY -= step;
            }
            return currentY;
          },
          /** 下载PDF */
          getPdf() {
            let ele = this.shadow.ele;
            let mdDom = ele.querySelector("#pdf");
            let doc = new jsPDF({
              orientation: "p", // 纵向（portrait）或横向（landscape）
              unit: "pt", // 单位：pt、mm、cm、in
              format: "a4", // 纸张格式：a4、a3、letter 等
            });

            this.pdfLoading = true;

            html2canvas(mdDom).then(async (canvas) => {
              const ctx = canvas.getContext("2d", { willReadFrequently: true });
              /** 图片宽度 */
              const c_w = canvas.width;
              /** 图片高度 */
              const c_h = canvas.height;

              const margin_top = 30;
              /** pdf 一页的页面宽度 */
              const pdf_page_w = doc.internal.pageSize.getWidth();
              /** pdf 一页的页面高度 */
              const pdf_page_h = doc.internal.pageSize.getHeight();

              /** pdf 页面总高度, 根据宽度比利缩放高度 */
              const pdf_page_total_h = pdf_page_w * (c_h / c_w);

              const height_ratio = pdf_page_total_h / c_h;
              const width_ratio = pdf_page_w / c_w;

              let y = 0;
              let page = 0;
              while (y < pdf_page_total_h) {
                y > 0 && doc.addPage();
                let page_content_height = pdf_page_h - margin_top * 2;
                const ratio = page_content_height / pdf_page_total_h;
                // 图片一个页面实际高度
                let img_height = c_h * ratio;
                // 找到适合的图片高度
                const empty_height = this.findNearestEmptyLine(
                  canvas,
                  ctx,
                  img_height,
                  page
                );

                if (Math.round(empty_height) !== Math.round(img_height)) {
                  // 图片高度减去 找到的适合的图片高度 就是 需要去除的高度 图片实际高度
                  const diff = img_height - empty_height;
                  // 图片实际高度 和 PDF 高度不一样，需要转换一下
                  const page_diff = pdf_page_total_h / c_h;

                  img_height = empty_height;

                  const diff_height = diff * page_diff;

                  page_content_height = page_content_height - diff_height;
                }
                // 最后一页可能有空白
                let _img_height = img_height;
                const _y = y / height_ratio;
                if (_y + img_height > canvas.height) {
                  _img_height = canvas.height - _y;
                }

                const { base64 } = await imgClipByPage(canvas, _y, _img_height);

                // PDF底部颜色跟随主题色
                const color = this.sys_store.theme === "dark" ? "#222" : "#fff";
                doc.setFillColor(color);
                doc.rect(0, 0, pdf_page_w, pdf_page_h, "F"); // "F" 表示填充

                doc.addImage(
                  base64,
                  "JEPG",
                  0,
                  margin_top,
                  pdf_page_w,
                  // 最后一页的空白处理
                  _img_height * height_ratio
                );
                y += page_content_height;
                page += 1;
              }

              const title = `${this.getTitle(this.title)}.pdf`;
              doc.save(title);
              this.pdfLoading = false;
            });
          },
        },
      };
    };
  </script>
</template>
