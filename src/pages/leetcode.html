<template page>
  <link rel="stylesheet" href="../css/tailwind-compat.css?v=0.2.8" />
  <link rel="stylesheet" href="../css/public.css?v=0.2.8" />
  <link rel="stylesheet" href="../css/uno.css?v=0.2.8" />
  <link rel="stylesheet" href="../css/uno-icon.css?v=0.2.8" />
  <l-m src="../component/common/l-switch.html"></l-m>
  <l-m src="../component/common/l-button.html"></l-m>

  <l-m src="../component/l-console-list.html"></l-m>
  <l-m src="../component/l-editor.html"></l-m>
  <div attr:class="`relative hfull flex flex-col ${theme}`">
    <div
      id="main"
      class="flex wfull relative flex-col overflow-hidden flex-1 bg-theme-bg"
    >
      <!-- 功能区 -->
      <div class="p3px pl16px m0 flex-between">
        <p class="text-14px max-sm:hidden">{{getTitle(title)}}</p>
        <div class="flex-between gap-x10px *:flex-shrink-0">
          <div class="relative">
            <l-button
              :loading="sys_store.loading"
              :icon="'i-pepicons-pop:reload'"
              on:on-click="restoreCode"
              class="peer"
            >
              还原代码
            </l-button>
            <div class="popover-box hidden peer-hover:block">
              <div
                class="flex flex-center px12px py3px inline-block gap-1 text-12px"
              >
                <span class="text-14px"> 还原代码 </span>
                <span class="b b-theme-hover rounded px4px">
                  {{sys_store.is_mac? '⌘':'Ctrl'}}
                </span>
                <span class="b b-theme-hover rounded w20px text-center">
                  '
                </span>
              </div>
            </div>
          </div>
          <div class="relative">
            <l-button
              :icon="'i-solar:play-bold'"
              on:on-click="runCode"
              class="peer"
            >
              运行
            </l-button>

            <div class="popover-box hidden peer-hover:block">
              <div class="flex flex-center px12px py3px inline-block gap-1">
                <span class="text-14px"> 运行 </span>
                <span class="b b-theme-hover rounded px4px text-12px">
                  {{sys_store.is_mac? '⌘':'Ctrl'}}
                </span>
                <span class="b b-theme-hover rounded px4px text-12px">⏎</span>
              </div>
            </div>
          </div>
        </div>
        <l-button
          :icon="!is_fullscreen ? 'i-tabler:arrows-maximize':'i-tabler:arrows-minimize'"
          on:on-click="toggleFullScreen"
        >
        </l-button>
      </div>
      <!-- 编辑区 -->
      <div class="flex-1 group relative flex b-y overflow-hidden b-theme-hover">
        <div
          id="split-0"
          class="relative flex-shrink-0 hfull overflow-hidden group-[.cursor-col-resize]:select-none group-[.cursor-col-resize]:pointer-events-none"
        >
          <l-editor
            :code="leetcode_code"
            :update-code="updateCode"
            on:load="editorLoad"
            on:keydown="editorKeydown"
          ></l-editor>
        </div>
        <div
          id="split-1"
          class="cursor-col-resize flex-shrink-0 !w6px overflow-hidden bg-theme-hover flex-center"
        >
          <i class="i-akar-icons:drag-vertical w16px h16px"></i>
        </div>
        <div
          id="split-2"
          class="relative flex-shrink-0 hfull overflow-hidden group-[.cursor-col-resize]:select-none group-[.cursor-col-resize]:pointer-events-none"
        >
          <l-console-list
            :log-list="logList"
            on:clear="clearLog"
          ></l-console-list>
        </div>
      </div>
    </div>

    <footer
      class="flex-shrink-0 flex-row flex-between !*:text-#0073ff *:flex *:items-center *:cursor-pointer !*:my8px"
    >
      <button class="l-btn" on:click="setNextTitle(pre_title)">
        <x-if :value="pre_title">
          <i class="i-mingcute:left-fill w24px h24px"></i>
          <span>{{getTitle(pre_title)}}</span>
        </x-if>
      </button>
      <button class="l-btn" on:click="setNextTitle(next_title)">
        <x-if :value="next_title">
          <span>{{getTitle(next_title)}}</span>
          <i class="i-mingcute:right-fill w24px h24px"></i>
        </x-if>
      </button>
    </footer>
  </div>

  <script>
    import screenfull from "https://esm.sh/screenfull@6.0.0";
    import dayjs from "https://esm.sh/dayjs@1.11.13";
    import Toast from "../component/common/Toast.js";
    import { keyboard, getCombinationKey } from "../js/Keyboard.mjs";
    export default async ({ load }) => {
      const { Split, createJsRunner, watchHtmlTheme } = await load(
        "../js/util.js"
      );
      const {
        sys_store,
        changeType,
        handleFileSuffix,
        setSysTitle,
        getContent,
        leetcode,
      } = await load("../store/system.js");
      const { page_store, setLeetcodeCode, setLeetcodeTitle } = await load(
        "../store/page-store.js"
      );
      const toast = new Toast(3);
      return {
        parent: "../layout-page.html",
        data: {
          page_store: {},
          sys_store: {},
          pre_title: "",
          next_title: "",
          is_fullscreen: false,
          leetcode_code: "",
          updateCode: null,
          title: "",
          logList: [],
          writeCode: null,
          onDestroy: null,
          theme: "light",
          observer: null,
        },
        loaded() {
          Split({
            els: [
              this.shadow.ele.querySelector("#split-0"),
              this.shadow.ele.querySelector("#split-1"),
              this.shadow.ele.querySelector("#split-2"),
            ],
          });
        },
        async attached() {
          changeType("leetcode", page_store.leetcode_title);

          this.sys_store = sys_store;
          this.page_store = page_store;
          this.leetcode_code = this.page_store.leetcode_code;
          this.setFooterTitle();
          this.updateCode = Date.now();

          const { id, writeCode, onDestroy } = createJsRunner(({ data }) => {
            if (data?.source && data.source == id) {
              this.logList.push(data);
            }
          });

          this.writeCode = writeCode;
          this.onDestroy = onDestroy;

          keyboard.on("Ctrl-Enter", this.runCode, this);
          keyboard.on("Ctrl-'", this.restoreCode, this);
          keyboard.on("Ctrl-S", this.saveCode, this);

          this.observer = watchHtmlTheme((theme) => {
            this.theme = theme;
          });
        },
        detached() {
          this.sys_store = null;
          this.page_store = null;
          this.onDestroy && this.onDestroy();
          this.observer && this.observer();

          keyboard.off("Ctrl-Enter", this.runCode, this);
          keyboard.off("Ctrl-'", this.restoreCode, this);
          keyboard.off("Ctrl-S", this.saveCode, this);
        },
        watch: {
          async "sys_store.title"(val) {
            if (!this.sys_store || this.sys_store.document_type !== leetcode) {
              return;
            }
            const { title } = this.sys_store || {};

            if (title && title !== this.page_store.leetcode_title) {
              this.restoreCode();
            }
          },
        },
        proto: {
          // 主动触发组合键事件
          editorKeydown(e) {
            const key = getCombinationKey(e.data);
            keyboard.trigger(key);
          },
          editorLoad() {
            const { title } = this.sys_store || {};

            setLeetcodeTitle(title ?? "");
            this.setFooterTitle();
          },
          clearLog() {
            this.logList = [];
          },
          // 运行代码
          runCode() {
            if (!this.page_store) return;
            const { leetcode_code } = this.page_store;
            if (this.writeCode) {
              this.logList = [];
              this.writeCode(leetcode_code);
            }
          },
          setFooterTitle() {
            if (!this.page_store) return;
            const { menus, title } = this.sys_store || {};

            this.title = this.page_store.leetcode_title;
            const index = menus.findIndex((item) => item === this.title);

            this.pre_title = menus[index - 1] || "";
            this.next_title = menus[index + 1] || "";
          },
          getTitle: handleFileSuffix,
          setNextTitle: setSysTitle,
          toggleFullScreen() {
            const element = this.shadow.ele.querySelector("#main");
            if (!screenfull.isEnabled) return;

            screenfull.toggle(element).then(() => {
              this.is_fullscreen = screenfull.isFullscreen;
            });
          },
          // 还原代码
          async restoreCode() {
            const leetcode_code = await getContent();
            setLeetcodeCode(leetcode_code);
            this.leetcode_code = leetcode_code;
            this.updateCode = Date.now();
          },
          saveCode() {
            toast.show("代码已经存储到本地，点击 还原代码 按钮立即还原");
          },
        },
      };
    };
  </script>
</template>
